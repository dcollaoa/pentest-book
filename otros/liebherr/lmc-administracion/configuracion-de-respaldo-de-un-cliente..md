# Configuración de respaldo de un cliente

#### Esta es una guía paso a paso  para configurar el respaldo de documentos de los usuarios en computadores corporativos

Se le debe dar prioridad a la configuración de los equipos que llevan **tiempo en la compañia** para así **evitar pérdida de datos**, luego ir con los que tienen computador a cargo para finalizar con los casos más largos de computadores **compartidos y en terreno**.

Para esto se debe usar un script y **no** simplemente **OneDrive** ya que ese respaldo no está garantizado y está enlazado a la cuenta del usuario. En caso de desvinculaciones toca reactivar esas cuentas para descargar lo que está en **OneDrive** y revisar que se haya descargado todo antes de volver a desactivar, agregando tiempo de monitoreo, además de otros detalles adicionales.

Como plus el usar el _script_nos permite monitorear de **forma silenciosa** usando **psexec y cmd** de forma **remota y masiva.**

#### Inicio

* Se inicia registrando la tarea en SHP: [Link para registrar una tarea](https://www.liebherr.i/sites/LMC/Administracion/IT/Lists/PlanificacionSoporte/EnProceso.aspx)
* La prioridad de esta tarea es baja. (3)
* El área de soporte es:  Instalación de S.O.

#### Cómo configurar permisos de carpeta y tareas programadas.

1\) **Carpeta backup raíz (Rara vez se realiza este paso).**

Este paso solo es necesario en caso de estar configurando una **NUEVA UBICACIÓN** de respaldos por: **falta de espacio en discos**, **cambio de máquina.**

Al configurar una carpeta compartida para respaldos se debe considerar una ruta compartida disponible desde **LAN, LIEBHERR y VPN** con suficiente espacio para respaldos. Por otro lado, se deben configurar los siguientes grupos en los permisos de la carpeta raíz donde estarán las carpetas de los usuarios.

2\) **Crear carpeta backup usuarios**

Crear carpeta para el usuario y configurar los permisos en el servidor a utilizar para el respaldo.&#x20;

Debemos ingresar a través de **Conexión a Escritorio Remoto e ingresar a nuestro servidor, en este caso LMCSV03.**  Con nuestras credenciales de administrador (ej: lmccoda).

![](<../../../.gitbook/assets/image (13).png>)

Vamos a nuestro explorador y buscamos el disco local y localizamos la carpeta **Backup\_LMC. (**D:\Backup\_LMC)

![](<../../../.gitbook/assets/image (5).png>)

Creamos la carpeta. El nombre de la carpeta debe tener el estandar  Username-rc-1. \
**Ejemplo: lmccod0-rc-1**

**Para configurar los permisos** se debe primero quitar la herencia y luego ajustar.

Propiedades -> Security -> Advanced -> **Disable Inheritance**

****![](<../../../.gitbook/assets/image (16).png>)****

&#x20;Click en **"Convert inhertied permissions into explicit permissions on this object"**

****![](<../../../.gitbook/assets/image (3).png>)****

**SYSTEM -> Edit -> Localizamos LMC-Backup-Users -> Remove**

****![](<../../../.gitbook/assets/image (18).png>)****

A continuación confirmamos que el login del usuario a agregar corresponde con el login del nombre de la carpeta (Username-rc-1).

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

Luego de esto agregamos permisos de **Modify** a nuestro usuario y apretamos Apply para aplicar cambios y luego OK.

![](<../../../.gitbook/assets/image (2).png>)

#### 3) Configuración de script para respaldo de usuarios

El respaldo se ejecuta mediante una tarea programada (schtasks), donde dicha tarea ejecuta un **script .vbs, para lanzar con .bat**.

Los archivos deben quedar en **C:\Apps\Backup** en el computador del usuario del que se está ejecutando el respaldo.

{% code title="Backup.vbs" overflow="wrap" %}
```visual-basic
set objshell = createobject("wscript.shell")
objshell.run "C:\apps\Backup\user_batch_robocopy.bat",vbhide
```
{% endcode %}

<pre class="language-batch" data-title="user_batch_robocopy.bat" data-overflow="wrap" data-line-numbers><code class="lang-batch">@echo off
::***************************************************
:: V 2022.10.17
:: Agregada ruta de OneDrive
<strong>::***************************************************
</strong>:: V 2022.05.03
:: Se elimina restricción horaria, dejando eso por el lado de la tarea programada
::***************************************************
:: V 2022.04.21
:: Corregida incompatibilidad de IPG con MT
::***************************************************
:: V 2019.10.28
:: Agregada opción de más hilos que las por defecto en robocopy
:: Agregada copia de los formatos de las firmas de correo
:: Agregado respaldo de libros abiertos en OneNote (registro)
::***************************************************
:: V 2016.11.15
:: Corregidas las rutas de las carpetas, se eliminan comillas en definición
:: para arreglar ruta en uso por xcopy
::***************************************************
:: V 2016.09.29
:: Agregado rango de ejecución en robocopy /RH:1000-1600 /PF
:: Agregado texto de fecha y hora al inicio de xcopy
:: Agregada opción de reinicio en xcopy /Z
:: Corregida ruta para almacenamiento de *.pst
::***************************************************

::--------------------------------------------------------------
:: Variables globales
::--------------------------------------------------------------
::carpeta de respaldo base
Set carpetaBckp=\\LMCSV03\Backup_LMC\%USERNAME%-rc-1
::En caso de direccionar archivos .pst a computador local, cambiar acá
Set carpetaBckp2=\\LMCSV03\Backup_LMC\%USERNAME%-rc-1
set timestamp=%date:~-4,4%%date:~-7,2%%date:~-10,2%
set logfilename=log_backup.txt
::Para respaldar escritorio cambiar a yes
set escritorio=no


::--------------------------------------------------------------
:: Validando que no esté ya en curso otra copia de backup
::--------------------------------------------------------------
tasklist /FI "IMAGENAME eq Robocopy.exe"  2>NUL | find /I /C "Robocopy.exe" > C:\Apps\Backup\proc_temp.txt
set /P contador= &#x3C; C:\Apps\Backup\proc_temp.txt
IF %contador% GTR 1 (
	::está corriendo varias veces, generando saturación en la red, se anulan ejecuciones para dejar sólo la actual
	taskkill /F /IM "cmd.exe"
	taskkill /F /IM "Robocopy.exe"
) else (
	IF %contador% GTR 0 (
		::Ya está corriendo, se omite aplicación actual
		echo %date% %time% - Backup ya en ejecución, se omite actual. >> C:\Apps\Backup\Log_Backup.txt
		goto final
	)
)

::--------------------------------------------------------------
:: Sección respaldo
::--------------------------------------------------------------

IF NOT EXIST "%carpetaBckp%" (
	echo %date% %time% - No existe carpeta para respaldo: %carpetaBckp% >> C:\Apps\Backup\Log_Backup.txt
	goto final
)

echo %timestamp% Respaldando usuario %USERNAME% desde %COMPUTERNAME% > "%carpetaBckp%\%logfilename%"
echo. >> "%carpetaBckp%\%logfilename%"

:: OneNote
IF EXIST "%LOCALAPPDATA%\Microsoft\OneNote" (
	robocopy "%LOCALAPPDATA%\Microsoft\OneNote" "%carpetaBckp%\OneNote" /V /MIR /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
	echo %timestamp% Exportando libros abiertos de OneNote para usuario %USERNAME% en %COMPUTERNAME% > "%carpetaBckp%\%logfilename%"
	reg export HCKU\Software\Microsoft\Office\16.0\OneNote\OpenNotebooks "%carpetaBckp%\libros-onenote-%USERNAME%.reg" /y
)
::Carpetas del usuario
IF %escritorio%==yes (
	robocopy "%USERPROFILE%\Desktop" "%carpetaBckp%\Desktop" /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
)
IF EXIST "%LOCALAPPDATA%\Microsoft\OneDrive" (
	robocopy "%USERPROFILE%\OneDrive" "%carpetaBckp%\OneDrive" /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
)
IF EXIST "%LOCALAPPDATA%\Microsoft\OneDrive - Liebherr" (
	robocopy "%USERPROFILE%\OneDrive - Liebherr" "%carpetaBckp%\OneDrive-Liebherr" /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
)
robocopy "%USERPROFILE%\Documents" "%carpetaBckp%\Documents" /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"

::WinDTE
IF EXIST "%APPDATA%\WinDTE-774617507" (
	robocopy "%APPDATA%\WinDTE-774617507" "%carpetaBckp%\WinDTE-774617507" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
)

:: Outlook
robocopy "%APPDATA%\Microsoft\Firmas" "%carpetaDestino%\Firmas" /V /MIR /Z /R:10 /LOG+:"%carpetaDestino%\%logfilename%"
robocopy "%LOCALAPPDATA%\Microsoft\Outlook" "%carpetaBckp2%\Outlook" *.pst /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"

::Revisando si existe carpeta adicional
IF NOT EXIST "%carpetaBckp2%\Outlook2" (
	echo.  >> %carpetaBckp%\%logfilename%
	echo %date% %time% - No existe carpeta Outlook2 >> %carpetaBckp%\%logfilename%
	echo %date% %time% - Creando carpeta Outlook2 >> %carpetaBckp%\%logfilename%
	echo.  >> %carpetaBckp%\%logfilename%
	mkdir "%carpetaBckp2%\Outlook2"
)
::otros pst
echo %date% %time% - xcopy %carpetaBckp2%\Outlook2 >> %carpetaBckp%\%logfilename%
forfiles /p "%USERPROFILE%\Documents" /s /m *.pst /C "cmd /c xcopy "@path" "%carpetaBckp2%\Outlook2\*" /F /D /Y /Z" >> "%carpetaBckp%\%logfilename%"

:final
exit 0
</code></pre>

_En caso de ser un computador compartido, se deben configurar tantas tareas programadas como sean necesarias para respaldar a los usuarios que lo utilizan. En este caso se debe ir cambiando el nombre de la tarea agregando un número secuencial al final del nombre, ej: Backup\_LMC1, Backup\_LMC2, etc._

Para ajustar la ruta del servidor de destino, se debe abrir el archivo \*.bat y editar el nombre de la carpeta de destino en las variables **carpetaBckp y carpetaBckp2**.&#x20;

<img src="../../../.gitbook/assets/image (10).png" alt="" data-size="original">

****
