# Restaurar / Migrar Usuario

#### Paso a paso para la migración de usuario

En resumen se utilizan dos scripts que se encuentran en **\\\lmcsvsccm01\SCCM\_apps\BackupUsers:**

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption><p>Directorio de scripts</p></figcaption></figure>

{% tabs %}
{% tab title="Script 1" %}
<pre class="language-batch" data-title="migracion_usuario-5.bat" data-overflow="wrap"><code class="lang-batch">@echo off
:: Definición usuario y carpetas
:: usuario = login usuario a migrar, esta variable se modifica segun el nombre de usuario.
set usuario=lmccod0
:: carpetaOrigen/Destino = Puede ser una carpeta compartida o un disco duro, 
<strong>set carpetaOrigen=\\lmcnb0773\c$\Users\%usuario%
</strong>set carpetaDestino=\\lmcsv03\Backup_LMC\%usuario%-rc-1

::variables internas
set timestamp=%date:~-4,4%%date:~-7,2%%date:~-10,2%
if %time:~0,2% LSS 10 (
	set timestamp=%timestamp%0%time:~1,1%%time:~3,2%%time:~6,2%
) else (
	set timestamp=%timestamp%%time:~0,2%%time:~3,2%%time:~6,2%
)
set logfilename=log_traspaso_files-%timestamp%.txt

echo %time% Copiando desde: %carpetaOrigen% hasta %carpetaDestino% >> "%carpetaDestino%\%logfilename%"

:: OneNote
IF EXIST "%carpetaOrigen%\AppData\Local\Microsoft\OneNote" (
	robocopy "%carpetaOrigen%\AppData\Local\Microsoft\OneNote" "%carpetaDestino%\OneNote" /V /MIR /Z /R:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
)
::one note office 2016
::echo %time% Exportando registro con datos de OneNote de %uid% >> "%carpetaDestino%\%logfilename%"
::reg export HKU\%uid%\Software\Microsoft\Office\16.0\OneNote\OpenNotebooks "%carpetaDestino%\libros-onenote-%usuario%-%timestamp%.reg"

::Varios del usuario
robocopy "%carpetaOrigen%\Favorites" "%carpetaDestino%\Favorites" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Desktop" "%carpetaDestino%\Desktop" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Downloads" "%carpetaDestino%\Downloads" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Pictures" "%carpetaDestino%\Pictures" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Contacts" "%carpetaDestino%\Contacts" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
::copiando solo documentos desde Documents, luego el resto de archivos
robocopy "%carpetaOrigen%\Documents" "%carpetaDestino%\Documents" /E /V /Z /R:10 /XA:SH /MT:10 /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\OneDrive" "%carpetaDestino%\OneDrive" /E /V /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\OneDrive - Liebherr" "%carpetaDestino%\OneDrive-Liebherr" /E /V /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE

:: Outlook
robocopy "%carpetaOrigen%\AppData\Roaming\Microsoft\Firmas" "%carpetaDestino%\Firmas" /V /MIR /Z /R:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
::firmas office 2016
echo %time% Exportando registro con datos de firma de %uid% >> "%carpetaDestino%\%logfilename%"
reg export HKU\%uid%\Software\Microsoft\Office\16.0\Outlook\Profiles\Outlook\9375CFF0413111d3B88A00104B2A6676\00000002 "%carpetaDestino%\firma-outlook-%usuario%-%timestamp%.reg"
robocopy "%carpetaOrigen%\AppData\Local\Microsoft\Outlook" "%carpetaDestino%\Outlook" /V /MIR /Z /R:10 /MT:10 /XF *.ost /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\AppData\Local\Microsoft\Outlook" "%carpetaDestino%\Outlook" *.ost /E /V /Z /R:10 /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE

::WinDTE
IF EXIST "%carpetaOrigen%\AppData\Roaming\WinDTE-774617507" (
	robocopy "%carpetaOrigen%\AppData\Roaming\WinDTE-774617507" "%carpetaDestino%\WinDTE-774617507" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
)

echo %time% obteniendo SID de %usuario% >> "%carpetaDestino%\%logfilename%"
wmic useraccount where "name='%usuario%' and domain='zdvw2k'" get sid >> "%carpetaDestino%\%logfilename%"
set uid=S-1-5-21-790525478-776561741-839522115-47994

@pause
@echo on
</code></pre>
{% endtab %}

{% tab title="Script 2" %}
{% code title="restaurar_usuario-5.bat" overflow="wrap" %}
```batch
@echo off
:: Definión usuario y carpetas
:: usuario = login usuario a migrar
set usuario=%USERNAME%
:: carpetaOrigen/Destino = Puede ser una carpeta compartida o un disco duro, 
set carpetaOrigen=\\lmcsv03\Backup_LMC\%usuario%-rc-1
set carpetaDestino=%USERPROFILE%

::variables internas
set timestamp=%date:~-4,4%%date:~-7,2%%date:~-10,2%
if %time:~0,2% LSS 10 (
	set timestamp=%timestamp%-0%time:~1,1%%time:~3,2%%time:~6,2%
) else (
	set timestamp=%timestamp%-%time:~0,2%%time:~3,2%%time:~6,2%
)

set logfilename=log_traspaso_files-%usuario%-%timestamp%.txt

echo %time% Copiando desde: %carpetaOrigen% hasta %carpetaDestino% >> "%carpetaDestino%\%logfilename%"
:: OneNote
IF EXIST "%carpetaOrigen%\OneNote" (
	robocopy "%carpetaOrigen%\OneNote" "%carpetaDestino%\AppData\Local\Microsoft\OneNote" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
)
::WinDTE
IF EXIST "%carpetaOrigen%\WinDTE-774617507" (
	robocopy "%carpetaOrigen%\WinDTE-774617507" "%carpetaDestino%\AppData\Roaming\WinDTE-774617507" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
)
::Varios del usuario
robocopy "%carpetaOrigen%\Favorites" "%carpetaDestino%\Favorites" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Desktop" "%carpetaDestino%\Desktop" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Downloads" "%carpetaDestino%\Downloads" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Pictures" "%carpetaDestino%\Pictures" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Contacts" "%carpetaDestino%\Contacts" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Documents" "%carpetaDestino%\Documents" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\OneDrive" "%carpetaDestino%\Documents\OneDrive" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\OneDrive-Liebherr" "%carpetaDestino%\Documents\OneDrive-LMC" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
:: Outlook
robocopy "%carpetaOrigen%\Firmas" "%carpetaDestino%\AppData\Roaming\Microsoft\Firmas" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Outlook" "%carpetaDestino%\AppData\Local\Microsoft\Outlook" /V /MIR /Z /R:10 /XA:SH /MT:10 /XF *.ost /LOG+:"%carpetaDestino%\%logfilename%" /TEE
robocopy "%carpetaOrigen%\Outlook" "%carpetaDestino%\AppData\Local\Microsoft\Outlook" *.ost /V /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaDestino%\%logfilename%" /TEE

@pause
@echo on
```
{% endcode %}
{% endtab %}
{% endtabs %}

{% hint style="info" %}
Para el funcionamiento correcto de los scripts de migración se deben modificar ciertas variables en ambos archivos.

El archivo restaurar-usuario-5.bat se debe alojar en C:\TempIT y se debe ejecutar con el usuario sin privilegios del dueño del backup.&#x20;

Por el contrario los archivos al estar usando la variable %userprofile% irían a la carpeta de administrador.

**Se debe verificar que nose encuentre abierto Outlook ni Skype (lync.exe)**
{% endhint %}

#### Como revisar la existencia de un proceso en ejecución de forma remota/local

```batch
tasklist /s lmcnb0773 /fi "imagename eq outlook.exe" 
tasklist /s lmcnb0773 /fi "imagename eq lync.exe" 
```

#### Dónde se encuentran alojados los ficheros OST de Outlook

```batch
%localappdata%\Microsoft\Outlook\
```

{% hint style="warning" %}
Se debe verificar que no se cree otro fichero .OST al iniciar por primera vez en Outlook.

Se debe ingresar con el mismo nombre que aparece en el OST. Se deben respetar mayúscula como minúscula.
{% endhint %}
