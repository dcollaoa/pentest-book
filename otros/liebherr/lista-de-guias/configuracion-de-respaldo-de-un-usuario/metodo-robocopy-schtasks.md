# Método Robocopy / schtasks

#### 1) Configuración de script para respaldo de usuarios

El respaldo se ejecuta mediante una tarea programada (schtasks), donde dicha tarea ejecuta un **script .vbs, para lanzar con .bat**.

Los archivos deben quedar en **C:\Apps\Backup** en el computador del usuario del que se está ejecutando el respaldo.

{% tabs %}
{% tab title="Script 1" %}
{% code title="Backup.vbs" overflow="wrap" %}
```visual-basic
set objshell = createobject("wscript.shell")
objshell.run "C:\apps\Backup\user_batch_robocopy.bat",vbhide
```
{% endcode %}
{% endtab %}

{% tab title="Script 2" %}
{% code title="user_batch_robocopy.bat" overflow="wrap" %}
```batch
@echo off
::***************************************************
:: V 2022.10.17
:: Agregada ruta de OneDrive
::***************************************************
:: V 2022.05.03
:: Se elimina restricción horaria, dejando eso por el lado de la tarea programada
::***************************************************
:: V 2022.04.21
:: Corregida incompatibilidad de IPG con MT
::***************************************************
:: V 2019.10.28
:: Agregada opción de más hilos que las por defecto en robocopy
:: Agregada copia de los formatos de las firmas de correo
:: Agregado respaldo de libros abiertos en OneNote (registro)
::***************************************************
:: V 2016.11.15
:: Corregidas las rutas de las carpetas, se eliminan comillas en definición
:: para arreglar ruta en uso por xcopy
::***************************************************
:: V 2016.09.29
:: Agregado rango de ejecución en robocopy /RH:1000-1600 /PF
:: Agregado texto de fecha y hora al inicio de xcopy
:: Agregada opción de reinicio en xcopy /Z
:: Corregida ruta para almacenamiento de *.pst
::***************************************************

::--------------------------------------------------------------
:: Variables globales
::--------------------------------------------------------------
::carpeta de respaldo base
Set carpetaBckp=\\LMCSV03\Backup_LMC\%USERNAME%-rc-1
::En caso de direccionar archivos .pst a computador local, cambiar acá
Set carpetaBckp2=\\LMCSV03\Backup_LMC\%USERNAME%-rc-1
set timestamp=%date:~-4,4%%date:~-7,2%%date:~-10,2%
set logfilename=log_backup.txt
::Para respaldar escritorio cambiar a yes
set escritorio=no


::--------------------------------------------------------------
:: Validando que no esté ya en curso otra copia de backup
::--------------------------------------------------------------
tasklist /FI "IMAGENAME eq Robocopy.exe"  2>NUL | find /I /C "Robocopy.exe" > C:\Apps\Backup\proc_temp.txt
set /P contador= < C:\Apps\Backup\proc_temp.txt
IF %contador% GTR 1 (
	::está corriendo varias veces, generando saturación en la red, se anulan ejecuciones para dejar sólo la actual
	taskkill /F /IM "cmd.exe"
	taskkill /F /IM "Robocopy.exe"
) else (
	IF %contador% GTR 0 (
		::Ya está corriendo, se omite aplicación actual
		echo %date% %time% - Backup ya en ejecución, se omite actual. >> C:\Apps\Backup\Log_Backup.txt
		goto final
	)
)

::--------------------------------------------------------------
:: Sección respaldo
::--------------------------------------------------------------

IF NOT EXIST "%carpetaBckp%" (
	echo %date% %time% - No existe carpeta para respaldo: %carpetaBckp% >> C:\Apps\Backup\Log_Backup.txt
	goto final
)

echo %timestamp% Respaldando usuario %USERNAME% desde %COMPUTERNAME% > "%carpetaBckp%\%logfilename%"
echo. >> "%carpetaBckp%\%logfilename%"

:: OneNote
IF EXIST "%LOCALAPPDATA%\Microsoft\OneNote" (
	robocopy "%LOCALAPPDATA%\Microsoft\OneNote" "%carpetaBckp%\OneNote" /V /MIR /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
	echo %timestamp% Exportando libros abiertos de OneNote para usuario %USERNAME% en %COMPUTERNAME% > "%carpetaBckp%\%logfilename%"
	reg export HCKU\Software\Microsoft\Office\16.0\OneNote\OpenNotebooks "%carpetaBckp%\libros-onenote-%USERNAME%.reg" /y
)
::Carpetas del usuario
IF %escritorio%==yes (
	robocopy "%USERPROFILE%\Desktop" "%carpetaBckp%\Desktop" /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
)
IF EXIST "%LOCALAPPDATA%\Microsoft\OneDrive" (
	robocopy "%USERPROFILE%\OneDrive" "%carpetaBckp%\OneDrive" /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
)
IF EXIST "%LOCALAPPDATA%\Microsoft\OneDrive - Liebherr" (
	robocopy "%USERPROFILE%\OneDrive - Liebherr" "%carpetaBckp%\OneDrive-Liebherr" /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
)
robocopy "%USERPROFILE%\Documents" "%carpetaBckp%\Documents" /XF ~*.* *.pst *.dat.log *.flv *.iso *.nrg *.ost *.vod *.wma *~*.tmp thumbs.db *.mp3 *.mp4 *.mpg *.mkv *.avi *.vob *.mov *.wmv /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"

::WinDTE
IF EXIST "%APPDATA%\WinDTE-774617507" (
	robocopy "%APPDATA%\WinDTE-774617507" "%carpetaBckp%\WinDTE-774617507" /V /MIR /Z /R:10 /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"
)

:: Outlook
robocopy "%APPDATA%\Microsoft\Firmas" "%carpetaDestino%\Firmas" /V /MIR /Z /R:10 /LOG+:"%carpetaDestino%\%logfilename%"
robocopy "%LOCALAPPDATA%\Microsoft\Outlook" "%carpetaBckp2%\Outlook" *.pst /V /E /Z /R:10 /PF /XA:SH /MT:10 /LOG+:"%carpetaBckp%\%logfilename%"

::Revisando si existe carpeta adicional
IF NOT EXIST "%carpetaBckp2%\Outlook2" (
	echo.  >> %carpetaBckp%\%logfilename%
	echo %date% %time% - No existe carpeta Outlook2 >> %carpetaBckp%\%logfilename%
	echo %date% %time% - Creando carpeta Outlook2 >> %carpetaBckp%\%logfilename%
	echo.  >> %carpetaBckp%\%logfilename%
	mkdir "%carpetaBckp2%\Outlook2"
)
::otros pst
echo %date% %time% - xcopy %carpetaBckp2%\Outlook2 >> %carpetaBckp%\%logfilename%
forfiles /p "%USERPROFILE%\Documents" /s /m *.pst /C "cmd /c xcopy "@path" "%carpetaBckp2%\Outlook2\*" /F /D /Y /Z" >> "%carpetaBckp%\%logfilename%"

:final
exit 0

```
{% endcode %}
{% endtab %}
{% endtabs %}

{% hint style="info" %}
_En caso de ser un computador compartido, se deben configurar tantas tareas programadas como sean necesarias para respaldar a los usuarios que lo utilizan. En este caso se debe ir cambiando el nombre de la tarea agregando un número secuencial al final del nombre, ej: Backup\_LMC1, Backup\_LMC2, etc._
{% endhint %}

Para ajustar la ruta del servidor de destino, se debe abrir el archivo \*.bat y editar el nombre de la carpeta de destino en las variables **carpetaBckp y carpetaBckp2**.&#x20;

![](<../../../../.gitbook/assets/image (6).png>)

#### **2) Activar tarea programada.**

Primero se debe descargar una copia del archivo Backup\_LMC-3.xml y editar el UserId del usuario a respaldar. El login se encuentra en el tag \<UserId>.

{% code title="Backup_LMC-3.xml" overflow="wrap" %}
```markup
<?xml version="1.0" encoding="UTF-16"?>
<Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">
  <RegistrationInfo>
    <Date>2016-08-18T09:15:15.9042473</Date>
    <Author>ZDVW2K\lmccod0</Author>
    <Description>Respaldo Automatico de Informacion</Description>
    <URI>\Backup_LMC</URI>
  </RegistrationInfo>
  <Triggers>
    <CalendarTrigger>
      <StartBoundary>2016-08-18T11:30:00</StartBoundary>
      <ExecutionTimeLimit>PT4H</ExecutionTimeLimit>
      <Enabled>true</Enabled>
      <RandomDelay>PT1H</RandomDelay>
      <ScheduleByDay>
        <DaysInterval>1</DaysInterval>
      </ScheduleByDay>
    </CalendarTrigger>
  </Triggers>
  <Principals>
    <Principal id="Author">
      <UserId>ZDVW2K\NOMBREDEUSUARIO</UserId>
      <LogonType>InteractiveToken</LogonType>
      <RunLevel>LeastPrivilege</RunLevel>
    </Principal>
  </Principals>
  <Settings>
    <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
    <DisallowStartIfOnBatteries>true</DisallowStartIfOnBatteries>
    <StopIfGoingOnBatteries>true</StopIfGoingOnBatteries>
    <AllowHardTerminate>true</AllowHardTerminate>
    <StartWhenAvailable>false</StartWhenAvailable>
    <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>
    <IdleSettings>
      <StopOnIdleEnd>true</StopOnIdleEnd>
      <RestartOnIdle>false</RestartOnIdle>
    </IdleSettings>
    <AllowStartOnDemand>true</AllowStartOnDemand>
    <Enabled>true</Enabled>
    <Hidden>true</Hidden>
    <RunOnlyIfIdle>false</RunOnlyIfIdle>
    <WakeToRun>false</WakeToRun>
    <ExecutionTimeLimit>P3D</ExecutionTimeLimit>
    <Priority>7</Priority>
  </Settings>
  <Actions Context="Author">
    <Exec>
      <Command>C:\Apps\Backup\Backup.vbs</Command>
    </Exec>
  </Actions>
</Task>
```
{% endcode %}

Copiar el archivo Backup\_LMC-3.xml en el computador de destino. De preferencia en la carpeta C:\TempIT.

Abrir CMD.exe como Administrador y ejecutar el comando de tareas.

```batch
schtasks /create /TN "Backup_LMC" /XML "C:\TempIT\Backup_LMC-3.xml" 
```

{% hint style="info" %}
_TIP 1: Si por error se importó un archivo sin editar, se puede eliminar la tarea con el siguiente comando:_&#x20;

```batch
schtasks /delete /TN "Backup_LMC" /F
```

_TIP 2: El comando schtasks también se puede usar de forma remota agregando el parámetro /S \<ComputerName>._

__

_TIP 3:_ Se puede revisar la configuración de la tarea configurada ejecutando:&#x20;

```batch
schtasks /query /TN "Backup_LMC" /XML
```
{% endhint %}

#### 5) Monitoreo de tarea programada

Para validar se puede ingresar a C:\Apps\Backup y ver la fecha del archivo **proc\_temp.txt.**&#x20;

{% hint style="warning" %}
El siguiente paso es hacer la migración del usuario y sus archivos.&#x20;
{% endhint %}
